---
output: pdf_document
---

# Pre-Processing Steps
```{r include=FALSE}
library(dplyr)
library(plotly)
library(ggplot2)
library(FactoMineR)
library(factoextra)
library(ggcorrplot)
library(pheatmap)
library(tidyverse)
library(gridExtra)
library(knitr)
library(fuzzyjoin)
library(kableExtra)
library(GGally)
shooting <- readxl::read_excel("Shooting.xlsx")
passing <- readxl::read_excel("Passing.xlsx")
passtypes <- readxl::read_excel("Pass Types.xlsx")
gsc <- readxl::read_excel("GSC.xlsx")
defensive <- readxl::read_excel("Defensive.xlsx")
possession <- readxl::read_excel("Possession.xlsx")
misc <- readxl::read_excel("Misc.xlsx")

```

## Function to remove column name and row number repetition

```{r}
preprocess <- function(df) {
  colnames(df) <- as.character(unlist(df[1,]))
  df$Rk <- as.character(df$Rk)
  df <- df[df$Rk != "Rk", ]
  df <- df[ , -which(colnames(df) == "Matches")]
  df <- df[ , -which(colnames(df) == "Rk")]
  return(df)
} 

shooting <- preprocess(shooting)
passing <- preprocess(passing)
passtypes <- preprocess(passtypes)
gsc <- preprocess(gsc)
defensive <- preprocess(defensive)
possession <- preprocess(possession)
misc <- preprocess(misc)

```

## Ensure no repetition of column names

```{r}
names(shooting) = c('Player','Nation','Pos','Squad','Age','Born','90s','Gls','Sh','SoT','SoT%','Sh p90','SoT p90','Gls pSh','Gls pSoT','Sh Dist','Sh FK','PK','PKA','xG','npxG','npxG pSh','G-xG','npG-xG')

names(defensive) = c('Player','Nation','Pos','Squad','Age','Born','90s','TacklesA','TacklesW','TklDef3rd','TklMid3rd','TklAtt3rd','1v1W','1v1A','1v1%','Past','Blocks','ShBlocked','PassBlocked','Int','Tkl+Int','Clr','Err')

names(gsc) = c('Player','Nation','Pos','Squad','Age','Born','90s','SCA','SCA90','SCAPassLive','SCAPassDead','SCADrib','SCASh','SCAFld','SCADef','GCA','GCA90','GCAPassLive','GCAPassDead','GCADrib','GCASh','GCAFld','GCADef')

names(misc) = c('Player','Nation','Pos','Squad','Age','Born','90s','YCrd','RCrd','2YCrd','Fls','Fld','Off','Crs','Int','TacklesW','PKwon','PKcon','OG','Recov','AerW','AerL','Aer%')

names(passing) = c('Player','Nation','Pos','Squad','Age','Born','90s','PassCmp','PassA','Pass%','PassTotDist','PassProgDist','ShortPassCmp','ShortPassA','ShortPass%','MedPassCmp','MedPassA','MedPass%','LongPassCmp','LongPassA','LongPass%','Ast','xAG','xA','A-xA','Key Passes','F3 Passes','PA Passes','PA Crosses','Prog Passes')

names(possession) = c('Player','Nation','Pos','Squad','Age','Born','90s','Touches','Touches DefPA','Touches Def3','Touches Mid3','Touches Att3','Touches AttPA','Touches Live','DribA','DribCmp','Drib%','Tackled','Tackled%','Carries','CarryTotDist','CarryProgDist','Prog Carries','F3 Carries','PA Carries','Mis','Dis','RecA','Prog Rec')

names(passtypes) = c('Player','Nation','Pos','Squad','Age','Born','90s','PassA','Live Passes','Dead Passes','PassesFK','Thruballs','Switches','Crs','Throwins','CK','InCK','OutCK','StCK','PassCmp','PassOff','PassBlocked')
```

## Join all datasets

```{r}
prem23 <- shooting %>%
  full_join(passing, by = c("Player", "Nation", "Pos", "Squad", "Age", "Born", "90s"))%>%
  full_join(passtypes, by = c("Player", "Nation", "Pos", "Squad", "Age", "Born", "90s")) %>%
  full_join(gsc, by = c("Player", "Nation", "Pos", "Squad", "Age", "Born", "90s")) %>%
  full_join(defensive, by = c("Player", "Nation", "Pos", "Squad", "Age", "Born", "90s")) %>%
  full_join(possession, by = c("Player", "Nation", "Pos", "Squad", "Age", "Born", "90s")) %>%
  full_join(misc, by = c("Player", "Nation", "Pos", "Squad", "Age", "Born", "90s"))
```

## Remove duplicate columns Crs, PassA, Int etc.

```{r}
prem23 <- prem23 %>%
  select(-matches("\\.y$"))
```

## Converting players to one main position, make columns numeric and minimum of 3 90s played

```{r}
prem23$Pos <- sapply(strsplit(as.character(prem23$Pos), ","), `[`, 1)

prem23 <- prem23 %>%
  mutate(across(.cols = -c(Player, Nation, Pos, Squad, Born), as.numeric))

prem23 <- prem23 %>%
  filter(`90s` >= 3)

```

##Filtering into positions

```{r}
prem_outfield <- prem23 %>%
  filter(Pos != "GK")

prem_df <- prem23 %>%
  filter(Pos == "DF")

write.csv(prem_df, "Prem_DF.csv")

prem_mf <- prem23 %>%
  filter(Pos == "MF")

write.csv(prem_mf, "Prem_MF.csv")

prem_fw <- prem23 %>%
  filter(Pos == "FW")

write.csv(prem_fw, "Prem_FW.csv")

prem_gk <- prem23 %>%
  filter(Pos == "GK")
```

## Scale function
```{r}
scale_function <- function(x) {
  x_mean <- mean(x)
  (x - x_mean) / x_mean
}
```

## Sorted loadings function
```{r}
get_sorted_loadings <- function(loadings, component_number) {
  
  sorted_loadings <- loadings[, component_number, drop = FALSE]
  
  sorted_loadings <- sorted_loadings[order(abs(sorted_loadings[, 1]), decreasing = TRUE), , drop = FALSE]
  
  sorted_loadings_df <- data.frame(
    variable = rownames(sorted_loadings),
    loading = format(sorted_loadings[, 1], digits = 2, scientific = FALSE)
  )
  
  return(sorted_loadings_df)
}
```

## Min Max scale function
```{r}
min_max_scale <- function(x) {
  return((x - min(x)) / (max(x) - min(x)) * 100)
}
```

# DEFENDERS 

## Prep
```{r}
prem_def <- read.csv("Prem_DF.csv")

prem_def_clean <- prem_def %>%
  select(-c(X, Player, Born, Pos, Nation, Squad, npG.xG, A.xA)) %>%
  select(where(~ !any(is.na(.))))

prem_def_zero_var_cols <- sapply(prem_def_clean, function(x) var(x) == 0)

prem_def_clean <- prem_def_clean[, !prem_def_zero_var_cols]

```

## Heatmap
```{r}
def_cor <- cor(prem_def_clean)
png(filename = "Def_Heatmap.png", width = 16, height = 16, units = "in", res = 400)


pheatmap(def_cor, 
         color = colorRampPalette(c("blue", "white", "red"))(100),
         breaks = seq(-1, 1, length.out = 101), 
         legend_breaks = seq(-1, 1, 0.5),       
         legend_labels = seq(-1, 1, 0.5),     
         cluster_rows = TRUE, 
         cluster_cols = TRUE,
         fontsize_row = 8,                      
         fontsize_col = 8,                      
         angle_col = 90, 
         cellwidth = 8,    
         cellheight = 8,   
         border_color = "black")

dev.off()




```

## Summary

```{r}
def_summary <- prem_def_clean %>%
  summarise(across(everything(), list(
    Mean = ~ round(mean(.), 2),
    SD = ~ round(sd(.), 2),
    CV = ~ round(sd(.) / mean(.), 2)
  )))

def_summary_table <- def_summary %>%
  pivot_longer(cols = everything(), names_to = c("Variable", ".value"), names_sep = "_") %>%
  arrange(Variable)


total_rows <- nrow(def_summary_table)
rows_per_set <- ceiling(total_rows / 3)

def_sets <- split(def_summary_table, ceiling(seq_along(def_summary_table$Variable) / rows_per_set))
max_rows <- max(sapply(def_sets, nrow))
def_sets <- lapply(def_sets, function(df) {
  if (nrow(df) < max_rows) {
    df[(nrow(df) + 1):max_rows, ] <- NA
  }
  df
})


def_summary_combined <- bind_cols(def_sets)

def_full_summary <- kable(def_summary_combined, 
      col.names = c("Response", "Mean", "SD", "CV", "Response", "Mean", "SD", "CV", "Response", "Mean", "SD", "CV"), 
      booktabs = TRUE, linesep = "") %>%
  kable_styling(latex_options = c("striped", "hold_position", "bordered"), position = "center", full_width = FALSE) %>%
  row_spec(0, bold = TRUE, color = "white", background = "#56B4E9", extra_css = "border: 1px solid black;") %>%
  row_spec(1:nrow(def_summary_combined), extra_css = "border: 1px solid black;") %>%
  column_spec(column = c(1, 5, 9), bold = TRUE)


save_kable(def_full_summary, "def_full_summary.png")



```

## PCA
```{r}

prem_def_scale <- as.data.frame(lapply(prem_def_clean, scale_function))

```

```{r}

prem_def_PCA <- princomp(prem_def_scale)
prem_def_PCA_sum <- summary(prem_def_PCA)
```


```{r}
def_scree <- fviz_eig(prem_def_PCA, addlabels = TRUE)


def_scree_data <- def_scree$data

scree_def <- ggplot(def_scree_data, aes(x = factor(dim), y = eig, group = 1)) +
  geom_bar(stat = "identity", width = 0.95, fill = "#56B4E9") +
  geom_line(color = "black") +
  geom_point(color = "black") +
  geom_text(aes(label = round(eig, 1)), vjust = -0.2, hjust = -0.2, size = 2.5) +
  labs(x = "Principal Components", y = "Variance Explained (%)") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5),
    panel.grid.major.x = element_blank(),
    panel.grid.minor = element_blank(),
    axis.title.x = element_blank()
  )

ggsave(filename = "scree_def.png", plot = scree_def, width = 4, height = 3, units = "in", dpi = 300)

```

```{r}

prem_def_loadings <- as.data.frame(prem_def_PCA$loadings[, 1:20])

def_pc1 <- get_sorted_loadings(prem_def_loadings, 1)
def_pc2 <- get_sorted_loadings(prem_def_loadings, 2)
def_pc3 <- get_sorted_loadings(prem_def_loadings, 3)
def_pc4 <- get_sorted_loadings(prem_def_loadings, 4)
def_pc5 <- get_sorted_loadings(prem_def_loadings, 5)


def_pc1_head <- tableGrob(head(def_pc1, n=5))
def_pc2_head <- tableGrob(head(def_pc2, n=5))
def_pc3_head <- tableGrob(head(def_pc3, n=5))
def_pc4_head <- tableGrob(head(def_pc4, n=5))
def_pc5_head <- tableGrob(head(def_pc5, n=5))


```

```{r}
def_pc1_top5 <- head(def_pc1, n=5)

def_pc1_labels <- c("SCAPassDead" = "SCA Set Piece", "OutCK" = "Outswing CK", "Sh.FK" = "FK Shot", "StCK" = "Straight CK", "InCK" = "Inswing CK", "CK" = "Corner Kick")

def_pc1_top5_plot <-ggplot(def_pc1_top5, aes(x = reorder(variable, abs(as.numeric(loading))), y = as.numeric(loading))) +
  geom_bar(stat = "identity", fill = "#56B4E9") +
  labs(title = "DEF Principal Component 1 (41.3%)",
       y = "Loading") +
  scale_x_discrete(labels = def_pc1_labels) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5,  face = "bold"),   
        panel.grid.major.x = element_blank(),
        axis.title.x = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(size = 10)) 


def_pc2_top5 <- head(def_pc2, n=5)

def_pc2_labels <- c("SCADef" = "SCA Defending", "GCADef" = "GCA\n Defending", "GCAFld" = "GCA\n Foul Drawn", "RCrd" = "Red Card", "G.xG" = "Goals\n - Expected Goals", "X2YCrd" = "2\n Yellow Cards")

def_pc2_top5_plot <-ggplot(def_pc2_top5, aes(x = reorder(variable, abs(as.numeric(loading))), y = as.numeric(loading))) +
  geom_bar(stat = "identity", fill = "#56B4E9") +
  labs(title = "DEF Principal Component 2 (11.9%)",
       y = "Loading") +
  scale_x_discrete(labels = def_pc2_labels) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5,  face = "bold"),   
        panel.grid.major.x = element_blank(),
        axis.title.x = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(size = 10)) 

def_pc3_top5 <- head(def_pc3, n=5)

def_pc3_labels <- c("GCAPassDead" = "GCA Set Piece", "PA.Carries" = "Penalty Area\n Dribbles", "StCK" = "Straight CK", "GCADrib" = "GCA Dribble", "RCrd" = "Red Card", "X2YCrd" = "2\n Yellow Cards")

def_pc3_top5_plot <-ggplot(def_pc3_top5, aes(x = reorder(variable, abs(as.numeric(loading))), y = as.numeric(loading))) +
  geom_bar(stat = "identity", fill = "#56B4E9") +
  labs(title = "DEF Principal Component 3 (8.9%)",
       y = "Loading") +
  scale_x_discrete(labels = def_pc3_labels) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5,  face = "bold"),   
        panel.grid.major.x = element_blank(),
        axis.title.x = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(size = 10)) 

def_pc4_top5 <- head(def_pc4, n=5)

def_pc4_labels <- c("StCK" = "Straight CK", "PKwon" = "Penalties Won", "GCADrib" = "GCA Dribble", "RCrd" = "Red Card", "GCADef" = "GCA\n Defending", "X2YCrd" = "2\n Yellow Cards")

def_pc4_top5_plot <-ggplot(def_pc4_top5, aes(x = reorder(variable, abs(as.numeric(loading))), y = as.numeric(loading))) +
  geom_bar(stat = "identity", fill = "#56B4E9") +
  labs(title = "DEF Principal Component 4 (7.8%)",
       y = "Loading") +
  scale_x_discrete(labels = def_pc4_labels) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5,  face = "bold"),   
        panel.grid.major.x = element_blank(),
        axis.title.x = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(size = 10))

def_pc5_top5 <- head(def_pc5, n=5)

def_pc5_labels <- c("X2YCrd" = "2 Yellow Cards", "OutCK" = "Outswing CK", "GCAPassDead" = "GCA\n Set Piece", "StCK" = "Straight CK", "GCAFld" = "GCA\n Foul Drawn", "PKwon" = "Penalties Won")

def_pc5_top5_plot <- ggplot(def_pc5_top5, aes(x = reorder(variable, abs(as.numeric(loading))), y = as.numeric(loading))) +
  geom_bar(stat = "identity", fill = "#56B4E9") +
  labs(title = "DEF Principal Component 5 (4.5%)",
       y = "Loading") +
  scale_x_discrete(labels = def_pc5_labels) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"),   
        panel.grid.major.x = element_blank(),
        axis.title.x = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(size = 10)) 

def_loadings_combined <- grid.arrange(def_pc1_top5_plot, def_pc2_top5_plot, def_pc3_top5_plot,
                          def_pc4_top5_plot, def_pc5_top5_plot,
                          ncol = 1)

ggsave(filename = "def_comp.png", plot = def_loadings_combined, width = 6, height = 8, units = "in", dpi = 300)
```


```{r}

prem_def_scores <- as.data.frame(prem_def_PCA$scores)

prem_def_scores$Comp.3 <- -prem_def_scores$Comp.3
prem_def_scores$Comp.4 <- -prem_def_scores$Comp.4
prem_def_scores$Comp.5 <- -prem_def_scores$Comp.5
```

```{r}

prem_def_scores$Overall_Score <- rowSums(prem_def_scores)

def_names <- prem_def$Player

prem_def_scores <- prem_def_scores %>%
  mutate(Player = def_names)
```

```{r}

prem_def_scores <- prem_def_scores %>%
  mutate(Scaled_Score = min_max_scale(Overall_Score))

prem_def_final <- prem_def_scores %>%
  select(Player,Overall_Score) %>%
  arrange(desc(Overall_Score))
```

```{r}
prem_def_scores <- prem_def_scores %>%
  mutate(Rank = rank(-Overall_Score)) 

prem_def_table <- prem_def_scores %>%
  select(Rank, Player, Comp.1, Comp.2, Comp.3, Comp.4, Comp.5, Overall_Score, Scaled_Score) %>%
  arrange(Rank)

prem_def_table <- prem_def_table %>%
  mutate(across(c(Comp.1, Comp.2, Comp.3, Comp.4, Comp.5, Overall_Score, Scaled_Score), ~ round(., 2)))

prem_def_table_top10 <- prem_def_table %>%
  top_n(10, wt = -Rank)
```

```{r}
library(gt)

colnames(prem_def_table_top10) <- c("Rank", "Player", "Set Pieces", "Aggressive, GCA Def", "Aggressive, Drib GCA", "Aggressive, GCA", "Set Pieces, Draw Fouls", "Overall Score", "Scaled Overall Score")

def_table <- gt(prem_def_table_top10) %>%
  tab_style(
    style = cell_text(weight = "bold", align = "center"),
    locations = cells_column_labels(everything())
  ) %>%
  tab_options(
    column_labels.background.color = "#56B4E9",  
    table.font.size = 12
  ) %>%
  tab_style(style = cell_borders(
    sides = "all", 
    color = "black",
    weight = px(1)
  ), locations = cells_body()
  ) %>%
  tab_style(
    style = cell_borders(
      sides = "all",
      color = "black",
      weight = px(1)
    ),
    locations = cells_column_labels()
  ) %>%
  tab_style(
    style = cell_text(align = "center"),
    locations = cells_body())

gtsave(def_table, "def_table_top10.png", expand = 8)
```


```{r}
def_top10_score <- prem_def_final %>%
  top_n(10, Overall_Score) %>%
  arrange(desc(Overall_Score))

 ggplot(def_top10_score, aes(x = reorder(Player, Overall_Score), y = Overall_Score)) +
  geom_segment(aes(xend = Player, yend = 0), color = "#56B4E9") +
  geom_point(color = "#56B4E9", size = 4) +
  coord_flip() +  
  labs(title = "Top 10 Defenders",
       x = "Player",
       y = "Overall Score") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5), 
    panel.grid.major.y = element_blank(),   
    panel.grid.minor.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    axis.text.y = element_text(size = 10, face = "bold"))
```


```{r}
def_score_head <- tableGrob(head(prem_def_final, n=10))
def_score_tail <- tableGrob(tail(prem_def_final, n=10))

def_scree

grid.arrange(def_pc1_head, def_pc2_head, def_pc3_head,
  def_pc4_head, def_pc5_head,
  ncol=3)

grid.arrange(
  def_score_head, def_score_tail,
  ncol = 2
)
```

## Key Raw Variables vs component scores

```{r}
def_plot_df <- prem_def %>%
  select(Pos, StCK, GCADef, X2YCrd, RCrd, PKwon, GCADrib, G.xG, A.xA, GCADrib, PA.Carries, GCAFld) %>% 
  bind_cols(prem_def_scores)
```

```{r}
def_1 <- ggplot(def_plot_df, aes(x = StCK, y = Comp.1, label = Player)) +
  geom_point(color = 'blue') +
  geom_text(aes(label = Player), vjust = 1.5, hjust = 1.5) +
  labs(title = "StCK vs. Principal Component 1",
       x = "StCK",
       y = "Principal Component 1 Score") +
  theme_minimal()

def_1 <- ggplotly(def_1)
def_1

def_2 <- ggplot(def_plot_df, aes(x = GCADef, y = Comp.2, label = Player)) +
  geom_point(color = 'blue') +
  geom_text(aes(label = Player), vjust = 1.5, hjust = 1.5) +
  labs(title = "GCADef vs. Principal Component 2",
       x = "GCADef",
       y = "Principal Component 2 Score") +
  theme_minimal()
def_2 <- ggplotly(def_2)
def_2

def_3 <- ggplot(def_plot_df, aes(x = X2YCrd, y = Comp.3, label = Player)) +
  geom_point(color = 'blue') +
  geom_text(aes(label = Player), vjust = 1.5, hjust = 1.5) +
  labs(title = "X2YCrd vs. Principal Component 3",
       x = "X2YCrd",
       y = "Principal Component 3 Score") +
  theme_minimal()
def_3 <- ggplotly(def_3)
def_3

def_4 <- ggplot(def_plot_df, aes(x = GCADrib, y = Comp.4, label = Player)) +
  geom_point(color = 'blue') +
  geom_text(aes(label = Player), vjust = 1.5, hjust = 1.5) +
  labs(title = "GCADrib vs. Principal Component 4",
       x = "GCADrib",
       y = "Principal Component 4 Score") +
  theme_minimal()
def_4 <- ggplotly(def_4)
def_4

def_5 <- ggplot(def_plot_df, aes(x = GCAFld, y = Comp.5, label = Player)) +
  geom_point(color = 'blue') +
  geom_text(aes(label = Player), vjust = 1.5, hjust = 1.5) +
  labs(title = "GCAFld vs. Principal Component 5",
       x = "GCAFld",
       y = "Principal Component 5 Score") +
  theme_minimal()
def_5 <- ggplotly(def_5)
def_5

```

```{r}

def_pc1_vs_pc2 <- ggplot(prem_def_scores, aes(x = Comp.1, y = Comp.2, label = Player)) +
  geom_point(color = '#56B4E9', alpha = 0.6, size = 2) +
  labs(title = "PC1 vs PC2 Scores",
       x = "Principal Component 1 (PC1)",
       y = "Principal Component 2 (PC2)") +
  theme_minimal()

def_pc1_vs_pc2 <-ggplotly(def_pc1_vs_pc2)

def_pc1_vs_pc2
```

```{r}
def_pc2_vs_pc3 <- ggplot(prem_def_scores, aes(x = Comp.2, y = Comp.3, label = Player)) +
  geom_point(color = '#56B4E9', alpha = 0.6, size = 2) +
  labs(title = "PC1 vs PC2 Scores",
       x = "Principal Component 2 (PC2)",
       y = "Principal Component 3 (PC3)") +
  theme_minimal()

def_pc2_vs_pc3 <-ggplotly(def_pc2_vs_pc3)

def_pc2_vs_pc3
```


# MIDFIELDERS

## Pre-processing
```{r}
prem <- read.csv("Prem23.csv")

prem_mid <- prem %>%
  filter(Pos == "MF")

prem_mid_clean <- prem_mid %>%
  select(-c(Player, Born, Pos, Nation, Squad, A.xA)) %>%
  select(where(~ !any(is.na(.))))


```

## Heatmap
```{r}
mid_cor <- cor(prem_mid_clean)

png(filename = "Mid_Heatmap.png", width = 16, height = 16, units = "in", res = 400)

pheatmap(mid_cor, 
         color = colorRampPalette(c("blue", "white", "red"))(100),
         breaks = seq(-1, 1, length.out = 101),
         legend_breaks = seq(-1, 1, 0.5),
         legend_labels = seq(-1, 1, 0.5),
         cluster_rows = TRUE, 
         cluster_cols = TRUE,
         fontsize_row = 8,  
         fontsize_col = 8, 
         angle_col = 90,
         cellwidth = 8,    
         cellheight = 8,   
         border_color = "black")  

dev.off()
```

```{r}
mid_summary <- prem_mid_clean %>%
  summarise(across(everything(), list(
    Mean = ~ round(mean(.), 2),
    SD = ~ round(sd(.), 2),
    CV = ~ round(sd(.) / mean(.), 2)
  )))

mid_summary_table <- mid_summary %>%
  pivot_longer(cols = everything(), names_to = c("Variable", ".value"), names_sep = "_") %>%
  arrange(Variable)


mid_total_rows <- nrow(mid_summary_table)
mid_rows_per_set <- ceiling(mid_total_rows / 3) 


mid_sets <- split(mid_summary_table, ceiling(seq_along(mid_summary_table$Variable) / mid_rows_per_set))
max_rows <- max(sapply(mid_sets, nrow))
mid_sets <- lapply(mid_sets, function(df) {
  if (nrow(df) < max_rows) {
    df[(nrow(df) + 1):max_rows, ] <- NA
  }
  df
})


mid_summary_combined <- bind_cols(mid_sets)


mid_full_summary <- kable(mid_summary_combined, 
      col.names = c("Response", "Mean", "SD", "CV", "Response", "Mean", "SD", "CV", "Response", "Mean", "SD", "CV"), 
      booktabs = TRUE, linesep = "", align = 'c') %>%
  kable_styling(latex_options = c("striped", "hold_position", "bordered"), position = "center", full_width = FALSE) %>%
  row_spec(0, bold = TRUE, color = "white", background = "#009E73", extra_css = "border: 1px solid black;") %>%
  row_spec(1:nrow(mid_summary_combined), extra_css = "border: 1px solid black;") %>%
  column_spec(column = c(1, 5, 9), bold = TRUE)


save_kable(mid_full_summary, "mid_full_summary.png")



```


 
## PCA
```{r}

prem_mid_scale <- as.data.frame(lapply(prem_mid_clean, scale_function))
```

```{r}

prem_mid_PCA <- princomp(prem_mid_scale)
prem_mid_PCA_sum <- summary(prem_mid_PCA)

mid_scree <- fviz_eig(prem_mid_PCA, addlabels = TRUE)


mid_scree_data <- mid_scree$data

scree_mid <- ggplot(mid_scree_data, aes(x = factor(dim), y = eig, group = 1)) +
  geom_bar(stat = "identity", width = 0.95, fill = "#009E73") +
  geom_line(color = "black") +
  geom_point(color = "black") +
  geom_text(aes(label = round(eig, 1)), vjust = -0.2, hjust = -0.2, size = 2.5) +
  labs(x = "Principal Components", y = "Variance Explained (%)") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5),
    panel.grid.major.x = element_blank(),
    panel.grid.minor = element_blank(),
    axis.title.x = element_blank()
  )

ggsave(filename = "scree_mid.png", plot = scree_mid, width = 4, height = 3, units = "in", dpi = 300)



```

```{r}

prem_mid_loadings <- as.data.frame(prem_mid_PCA$loadings[, 1:20])

mid_pc1 <- get_sorted_loadings(prem_mid_loadings, 1)
mid_pc2 <- get_sorted_loadings(prem_mid_loadings, 2)



mid_pc1_head <- tableGrob(head(mid_pc1, n=5))
mid_pc2_head <- tableGrob(head(mid_pc2, n=5))



```

```{r}
mid_pc1_top5 <- head(mid_pc1, n=5)

mid_pc1_labels <- c("Gls" = "Goals", "OG" = "Own Goals", "Sh.FK" = "FK Shot", "StCK" = "Straight CK", "G.xG" = "Goals\n - Expected\n Goals", "npG.xG" = "Non Penalty\n Goals\n - Expected Goals")

mid_pc1_top5_plot <- ggplot(mid_pc1_top5, aes(x = reorder(variable, abs(as.numeric(loading))), y = as.numeric(loading))) +
  geom_bar(stat = "identity", fill = "#009E73") +
  ylim(-0.8, 0.2) +
  labs(title = "MID Principal Component 1 (85.9%)",
       x = "Variable",
       y = "Loading") +
  scale_x_discrete(labels = mid_pc1_labels) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"),   
        panel.grid.major.x = element_blank(),
        axis.title.x = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(size = 10))

mid_pc2_top5 <- head(mid_pc2, n=5)

mid_pc2_labels <- c("SCAPassDead" = "SCA\n Set Piece", "GCAPassDead" = "GCA\n Set Piece", "Sh.FK" = "FK Shot", "OutCK" = "Outswing CK", "PKA" = "Penalty Attempts", "PK" = "Penalty Goals")
  
mid_pc2_top5_plot <- ggplot(mid_pc2_top5, aes(x = reorder(variable, abs(as.numeric(loading))), y = as.numeric(loading))) +
  geom_bar(stat = "identity", fill = "#009E73") +
  labs(title = "MID Principal Component 2 (3.7%)",
       x = "Variable",
       y = "Loading") +
  scale_x_discrete(labels = mid_pc2_labels) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, , face = "bold"),   
        panel.grid.major.x = element_blank(), 
        axis.title.x = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(size = 10,))

mid_loadings_combined <- grid.arrange(mid_pc1_top5_plot, mid_pc2_top5_plot,
                          ncol = 1)

ggsave(filename = "mid_comp.png", plot = mid_loadings_combined, width = 6, height = 6, units = "in", dpi = 300)
```



```{r}

prem_mid_scores <- as.data.frame(prem_mid_PCA$scores)
```

```{r}

prem_mid_scores$Overall_Score <- rowSums(prem_mid_scores)

mid_names <- prem_mid$Player

prem_mid_scores <- prem_mid_scores %>%
  mutate(Player = mid_names)
```

```{r}

prem_mid_scores <- prem_mid_scores %>%
  mutate(Scaled_Score = min_max_scale(Overall_Score))

prem_mid_final <- prem_mid_scores %>%
  select(Player,Overall_Score) %>%
  arrange(desc(Overall_Score))
```

```{r}
prem_mid_scores <- prem_mid_scores %>%
  mutate(Rank = rank(-Overall_Score)) 

prem_mid_table <- prem_mid_scores %>%
  select(Rank, Player, Comp.1, Comp.2, Overall_Score, Scaled_Score) %>%
  arrange(Rank)

prem_mid_table <- prem_mid_table %>%
  mutate(across(c(Comp.1, Comp.2, Overall_Score, Scaled_Score), ~ round(., 2)))

prem_mid_table_top10 <- prem_mid_table %>%
  top_n(10, wt = -Rank)
```

```{r}


colnames(prem_mid_table_top10) <- c("Rank", "Player", "Taking Their Chances", "Set Pieces", "Overall Score", "Scaled Overall Score")

mid_table <- gt(prem_mid_table_top10) %>%
  tab_style(
    style = cell_text(weight = "bold", align = "center"),
    locations = cells_column_labels(everything())
  ) %>%
  tab_options(
    column_labels.background.color = "#009E73",  
    table.font.size = 12
  ) %>%
  tab_style(style = cell_borders(
    sides = "all", 
    color = "black",
    weight = px(1)
  ), locations = cells_body()
  ) %>%
  tab_style(
    style = cell_borders(
      sides = "all",
      color = "black",
      weight = px(1)
    ),
    locations = cells_column_labels()
  ) %>%
  tab_style(
    style = cell_text(align = "center"),
    locations = cells_body())

gtsave(mid_table, "mid_table_top10.png", expand = 8)

```


```{r}
mid_top10_score <- prem_mid_final %>%
  top_n(10, Overall_Score) %>%
  arrange(desc(Overall_Score))

 ggplot(mid_top10_score, aes(x = reorder(Player, Overall_Score), y = Overall_Score)) +
  geom_segment(aes(xend = Player, yend = 0), color = "#009E73") +
  geom_point(color = "#009E73", size = 4) +
  coord_flip() +  
  labs(title = "Top 10 Midfielders",
       x = "Player",
       y = "Overall Score") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5),  
    panel.grid.major.y = element_blank(),   
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    axis.text.y = element_text(size = 10, face = "bold"))
```



```{r}
mid_score_head <- tableGrob(head(prem_mid_final, n=10))
mid_score_tail <- tableGrob(tail(prem_mid_final, n=10))

mid_scree

grid.arrange(mid_pc1_head, mid_pc2_head,
  ncol=2)

grid.arrange(
  mid_score_head, mid_score_tail,
  ncol = 2
)
```

# Key Raw Variables vs component scores
```{r}
mid_plot_df <- prem_mid %>%
  select(Pos, PK, PKA, G.xG, npG.xG, OutCK, Sh.FK) %>% 
  bind_cols(prem_mid_scores)
```

```{r}
mid_1 <- ggplot(mid_plot_df, aes(x = npG.xG, y = Comp.1, label = Player)) +
  geom_point(color = 'blue') +
  geom_text(aes(label = Player), vjust = 1.5, hjust = 1.5) +
  labs(title = "npG.xG vs. Principal Component 1",
       x = "npG.xG",
       y = "Principal Component 1 Score") +
  theme_minimal()

mid_1 <- ggplotly(mid_1)
mid_1

mid_2 <- ggplot(mid_plot_df, aes(x = Sh.FK, y = Comp.2, label = Player)) +
  geom_point(color = 'blue') +
  geom_text(aes(label = Player), vjust = 1.5, hjust = 1.5) +
  labs(title = "Sh.FK vs. Principal Component 2",
       x = "Sh.FK",
       y = "Principal Component 2 Score") +
  theme_minimal()
mid_2 <- ggplotly(mid_2)
mid_2


```


```{r}
prem_mid_loadings$Variable <- rownames(prem_mid_loadings)
```

```{r}
mid_pc1_vs_pc2 <- ggplot(prem_mid_scores, aes(x = Comp.1, y = Comp.2, label = Player)) +
  geom_point(color = '#009E73', alpha = 0.6, size = 2) +
  labs(title = "PC1 vs PC2 Scores",
       x = "Principal Component 1 (PC1)",
       y = "Principal Component 2 (PC2)") +
  theme_minimal()

mid_pc1_vs_pc2 <-ggplotly(mid_pc1_vs_pc2)


```

```{r}
annotations <- list(
  list(
    x = prem_mid_scores$Comp.1[prem_mid_scores$Player == "Christian Eriksen"],
    y = prem_mid_scores$Comp.2[prem_mid_scores$Player == "Christian Eriksen"],
    text = "Christian Eriksen",
    showarrow = TRUE,
    arrowhead = 7,
    ax = 20,
    ay = -20
  ),
  list(
    x = prem_mid_scores$Comp.1[prem_mid_scores$Player == "James Ward-Prowse"],
    y = prem_mid_scores$Comp.2[prem_mid_scores$Player == "James Ward-Prowse"],
    text = "James Ward-Prowse",
    showarrow = TRUE,
    arrowhead = 7,
    ax = 20,
    ay = -20
  )
)


mid_pc1_vs_pc2 <- mid_pc1_vs_pc2 %>%
  layout(annotations = annotations)

mid_pc1_vs_pc2
```

# FORWARDS

## Pre-processing
```{r}
prem <- read.csv("Prem23.csv")

prem_fwd <- prem %>%
  filter(Pos == "FW")

prem_fwd_clean <- prem_fwd %>%
  select(-c(Player, Born, Pos, Nation, Squad, A.xA)) %>%
  select(where(~ !any(is.na(.))))

```

## Heatmap
```{r}
fwd_cor <- cor(prem_fwd_clean)

png(filename = "Fwd_Heatmap.png", width = 16, height = 16, units = "in", res = 400)

pheatmap(fwd_cor, 
         color = colorRampPalette(c("blue", "white", "red"))(100),
         breaks = seq(-1, 1, length.out = 101),
         legend_breaks = seq(-1, 1, 0.5),
         legend_labels = seq(-1, 1, 0.5),
         cluster_rows = TRUE, 
         cluster_cols = TRUE,
         fontsize_row = 8,  
         fontsize_col = 8, 
         angle_col = 90,
         cellwidth = 8,    
         cellheight = 8,   
         border_color = "black")  

dev.off()
```

```{r}
fwd_summary <- prem_fwd_clean %>%
  summarise(across(everything(), list(
    Mean = ~ round(mean(.), 2),
    SD = ~ round(sd(.), 2),
    CV = ~ round(sd(.) / mean(.), 2)
  )))

fwd_summary_table <- fwd_summary %>%
  pivot_longer(cols = everything(), names_to = c("Variable", ".value"), names_sep = "_") %>%
  arrange(Variable)

fwd_total_rows <- nrow(fwd_summary_table)
fwd_rows_per_set <- ceiling(fwd_total_rows / 3) 


fwd_sets <- split(fwd_summary_table, ceiling(seq_along(fwd_summary_table$Variable) / fwd_rows_per_set))
max_rows <- max(sapply(fwd_sets, nrow))
fwd_sets <- lapply(fwd_sets, function(df) {
  if (nrow(df) < max_rows) {
    df[(nrow(df) + 1):max_rows, ] <- NA
  }
  df
})


fwd_summary_combined <- bind_cols(fwd_sets)


fwd_full_summary <- kable(fwd_summary_combined, 
      col.names = c("Response", "Mean", "SD", "CV", "Response", "Mean", "SD", "CV", "Response", "Mean", "SD", "CV"), 
      booktabs = TRUE, linesep = "", align = 'c') %>%
  kable_styling(latex_options = c("striped", "hold_position", "bordered"), position = "center", full_width = FALSE) %>%
  row_spec(0, bold = TRUE, color = "white", background = "#CC79A7", extra_css = "border: 1px solid black;") %>%
  row_spec(1:nrow(fwd_summary_combined), extra_css = "border: 1px solid black;") %>%
  column_spec(c(1, 5, 9), bold = TRUE)


save_kable(fwd_full_summary, "fwd_full_summary.png")
```

 
## PCA
```{r}

prem_fwd_scale <- as.data.frame(lapply(prem_fwd_clean, scale_function))
```

```{r}

prem_fwd_PCA <- princomp(prem_fwd_scale)
prem_fwd_PCA_sum <- summary(prem_fwd_PCA)

fwd_scree <- fviz_eig(prem_fwd_PCA, addlabels = TRUE)


fwd_scree_data <- fwd_scree$data

scree_fwd <- ggplot(fwd_scree_data, aes(x = factor(dim), y = eig, group = 1)) +
  geom_bar(stat = "identity", width = 0.95, fill = "#CC79A7") +
  geom_line(color = "black") +
  geom_point(color = "black") +
  geom_text(aes(label = round(eig, 1)), vjust = -0.2, hjust = -0.2, size = 2.5) +
  labs(x = "Principal Components", y = "Variance Explained (%)") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5),
    panel.grid.major.x = element_blank(),
    panel.grid.minor = element_blank(),
    axis.title.x = element_blank()
  )

ggsave(filename = "scree_fwd.png", plot = scree_fwd, width = 4, height = 3, units = "in", dpi = 300)

```

```{r}

prem_fwd_loadings <- as.data.frame(prem_fwd_PCA$loadings[, 1:20])

fwd_pc1 <- get_sorted_loadings(prem_fwd_loadings, 1)
fwd_pc2 <- get_sorted_loadings(prem_fwd_loadings, 2)



fwd_pc1_head <- tableGrob(head(fwd_pc1, n=5))
fwd_pc2_head <- tableGrob(head(fwd_pc2, n=5))



```

```{r}
fwd_pc1_top5 <- head(fwd_pc1)

fwd_pc1_labels <- c("RCrd" = "Red Card", "Gls" = "Goals", "X2YCrd" = "2\n Yellow Cards", "PK" = "Penalty Goals", "G.xG" = "Goals\n - Expected\n Goals", "npG.xG" = "Non Penalty\n Goals\n - Expected\n Goals")

fwd_loadings_combined <- ggplot(fwd_pc1_top5, aes(x = reorder(variable, abs(as.numeric(loading))), y = as.numeric(loading))) +
  geom_bar(stat = "identity", fill = "#CC79A7") +
  ylim(-1, 0.2) +
  labs(title = "FWD Principal Component 1 (94.7%)",
       x = "Variable",
       y = "Loading") +
  scale_x_discrete(labels = fwd_pc1_labels) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"),   
        panel.grid.major.x = element_blank(),
        axis.title.x = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(size = 8))

ggsave(filename = "fwd_comp.png", plot = fwd_loadings_combined, width = 6, height = 3, units = "in", dpi = 300)
```


```{r}

prem_fwd_scores <- as.data.frame(prem_fwd_PCA$scores)


```

```{r}

prem_fwd_scores$Overall_Score <- rowSums(prem_fwd_scores)

fwd_names <- prem_fwd$Player

prem_fwd_scores <- prem_fwd_scores %>%
  mutate(Player = fwd_names)
```

```{r}

prem_fwd_scores <- prem_fwd_scores %>%
  mutate(Scaled_Score = min_max_scale(Overall_Score))

prem_fwd_final <- prem_fwd_scores %>%
  select(Player,Overall_Score) %>%
  arrange(desc(Overall_Score))
```

```{r}
prem_fwd_scores <- prem_fwd_scores %>%
  mutate(Rank = rank(-Overall_Score)) 

prem_fwd_table <- prem_fwd_scores %>%
  select(Rank, Player, Comp.1, Overall_Score, Scaled_Score) %>%
  arrange(Rank)

prem_fwd_table <- prem_fwd_table %>%
  mutate(across(c(Comp.1, Overall_Score, Scaled_Score), ~ round(., 2)))

prem_fwd_table_top10 <- prem_fwd_table %>%
  top_n(10, wt = -Rank)
```

```{r}
colnames(prem_fwd_table_top10) <- c("Rank", "Player", "Taking Their Chances", "Overall Score", "Scaled Overall Score")

fwd_table <- gt(prem_fwd_table_top10) %>%
  tab_style(
    style = cell_text(weight = "bold", align = "center"),
    locations = cells_column_labels(everything())
  ) %>%
  tab_options(
    column_labels.background.color = "#CC79A7",  
    table.font.size = 12
  ) %>%
  tab_style(style = cell_borders(
    sides = "all", 
    color = "black",
    weight = px(1)
  ), locations = cells_body()
  ) %>%
  tab_style(
    style = cell_borders(
      sides = "all",
      color = "black",
      weight = px(1)
    ),
    locations = cells_column_labels()
  ) %>%
  tab_style(
    style = cell_text(align = "center"),
    locations = cells_body())

gtsave(fwd_table, "fwd_table_top10.png", expand = 8)
```

```{r}
fwd_top10_score <- prem_fwd_final %>%
  top_n(10, Overall_Score) %>%
  arrange(desc(Overall_Score))

 ggplot(fwd_top10_score, aes(x = reorder(Player, Overall_Score), y = Overall_Score)) +
  geom_segment(aes(xend = Player, yend = 0), color = "#CC79A7") +
  geom_point(color = "#CC79A7", size = 4) +
  coord_flip() +  
  labs(title = "Top 10 Forwards",
       x = "Player",
       y = "Overall Score") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5),  
    panel.grid.major.y = element_blank(),   
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank(),
    panel.grid.minor.y = element_blank(),
        axis.text.y = element_text(size = 10, face = "bold"))
```


```{r}
fwd_score_head <- tableGrob(head(prem_fwd_final, n=10))
fwd_score_tail <- tableGrob(tail(prem_fwd_final, n=10))

fwd_scree

grid.arrange(fwd_pc1_head, fwd_pc2_head,
  ncol=2)

grid.arrange(
  fwd_score_head, fwd_score_tail,
  ncol = 2
)
```

# Key Raw Variables vs component scores
```{r}
fwd_plot_df <- prem_fwd %>%
  select(Pos, G.xG, npG.xG, X2YCrd, OG) %>% 
  bind_cols(prem_fwd_scores)
```

```{r}
fwd_1 <- ggplot(fwd_plot_df, aes(x = npG.xG, y = Comp.1, label = Player)) +
  geom_point(color = 'blue') +
  geom_text(aes(label = Player), vjust = 1.5, hjust = 1.5) +
  labs(title = "npG.xG vs. Principal Component 1",
       x = "npG.xG",
       y = "Principal Component 1 Score") +
  theme_minimal()

fwd_1 <- ggplotly(fwd_1)
fwd_1

fwd_2 <- ggplot(fwd_plot_df, aes(x = X2YCrd, y = Comp.2, label = Player)) +
  geom_point(color = 'blue') +
  geom_text(aes(label = Player), vjust = 1.5, hjust = 1.5) +
  labs(title = "X2YCrd vs. Principal Component 2",
       x = "X2YCrd",
       y = "Principal Component 2 Score") +
  theme_minimal()
fwd_2 <- ggplotly(fwd_2)
fwd_2


```

```{r}
prem_fwd_loadings$Variable <- rownames(prem_fwd_loadings)
```

```{r}
fwd_pc1_vs_pc2 <- ggplot(prem_fwd_scores, aes(x = Comp.1, y = Comp.2, label = Player)) +
  geom_point(color = 'blue', alpha = 0.6, size = 2) +
  geom_text(aes(label = Player), size = 3, vjust = 1.5, hjust = 1.5, check_overlap = TRUE) +
  labs(title = "PC1 vs PC2 Scores",
       x = "Principal Component 1 (PC1)",
       y = "Principal Component 2 (PC2)") +
  theme_minimal()

ggplotly(fwd_pc1_vs_pc2)
```


# Transfermarkt Values

```{r}
transfer_value <- readxl::read_excel("TransferMarket.xlsx")

transfer_value_clean <- transfer_value %>%
  select(-`Date of birth/Age`, -Height, -Joined)
```

## Remove players with - as transfer value

```{r}
transfer_value_clean <- transfer_value_clean %>%
  filter(`Market value` != "-")
```

## Function to convert market values to numeric

```{r}
convert_market_value <- function(value) {
 
  value <- gsub("€", "", value)
  
  if (grepl("m", value)) {
    value <- as.numeric(gsub("m", "", value)) * 1e6
  }
  
  else if (grepl("k", value)) {
    value <- as.numeric(gsub("k", "", value)) * 1e3
  }
  
  return(value)
}
transfer_value_clean <- transfer_value_clean %>%
  mutate(`Market value` = sapply(`Market value`, convert_market_value))
```

## Remove scientific notation

```{r}
transfer_value_clean$`Market value` <- unname(transfer_value_clean$`Market value`)
options(scipen=999)
```

```{r}
transfer_value_clean <- transfer_value_clean %>%
  select(-`Team`)
```

## Merge with prem outfielders

```{r}
ff_data  <- stringdist_left_join(prem_outfield, transfer_value_clean, by = "Player", max_dist = 0.1, method = "jw")
```

##Remove duplicates and keep distinct players on distinct teams

```{r}
ff_data <- ff_data %>%
  distinct(Player.x, Squad, .keep_all = TRUE)
```

##Random forest data select

```{r}
forest_data <- ff_data %>%
  select(-c(Player.x, Player.y, Nation, Squad, Born)) %>%
  mutate(`Market value` = as.numeric(trimws(`Market value`)))
```



## Position splitting for model fit

```{r}
def_transfer <- forest_data %>%
  filter(Pos == "DF")

def_transfer <- def_transfer %>%
  select(-Pos) %>%
  select(where(~ !any(is.na(.))))
```

```{r}
mid_transfer <- forest_data %>%
  filter(Pos == "MF")

mid_transfer <- mid_transfer %>%
  select(-Pos) %>%
  select(where(~ !any(is.na(.))))
```

```{r}
fwd_transfer <- forest_data %>%
  filter(Pos == "FW")

fwd_transfer <- fwd_transfer %>%
  select(-Pos) %>%
  select(where(~ !any(is.na(.))))
```

# Random Forest

# DEFENDERS

```{r}
library(caret)
library(randomForest)
set.seed(123456)
def_index <- createDataPartition(def_transfer$`Market value`, 
                             p=0.7,
                             list=FALSE, 
                             times = 1)
def_transfer.train <- def_transfer[def_index,]
def_transfer.test <- def_transfer[-def_index,]
```

```{r}
def_rf_fit <- train(`Market value` ~ .,
                               data = def_transfer.train,
                               method = 'rf',
                               importance = TRUE,
                               trControl = trainControl(method = 'cv', number = 10))
```

```{r}
def_rf_fit
```

```{r}
varImp(def_rf_fit)
def_var_importance <- varImp(def_rf_fit, scale = FALSE)

def_var_importance_df <- data.frame(Variable = rownames(def_var_importance$importance), Importance = def_var_importance$importance[,1])

def_var_importance_df <- def_var_importance_df %>%
  arrange(desc(Importance))

def_top_5_importance <- head(def_var_importance_df, 5)

def_rf_labels <- c("CarryProgDist" = "Progressive Carrying\n Distance", "CarryTotDist" = "Total Carrying\n Distance", "DribCmp" = "Dribbles Complete", "ShortPassCmp" = "Short Pass\n Complete")

def_varimp <- ggplot(def_top_5_importance, aes(x = reorder(Variable, Importance), y = Importance)) +
  geom_bar(stat = "identity", fill = "#56B4E9") +
  coord_flip() +
  labs(x = "Variable",
       y = "Importance") +
  scale_x_discrete(labels = def_rf_labels) +
  theme_minimal() +
   theme(
    plot.title = element_text(hjust = 0.5),       
    panel.grid.major.y = element_blank(),          
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank(),
    panel.grid.minor.y = element_blank(),
        axis.text.y = element_text(size = 10))

ggsave(filename = "def_varimp.png", plot = def_varimp, width = 7, height = 5, units = "in", dpi = 300)
```


```{r}
def_rf_RMSE <- sqrt(mean((def_transfer.test$`Market value` - predict(def_rf_fit, def_transfer.test))^2))
def_rf_RMSE
```

```{r}
def_transfer_mean <- mean(def_transfer$`Market value`)
def_transfer_mean
```

```{r}
def_relative_error <- (def_rf_RMSE/def_transfer_mean) * 100
def_relative_error
```

## Data prep for predictions and residuals

```{r}
def_predictions <- ff_data %>%
  select(-c(Player.y, Nation, Squad, Born)) %>%
  mutate(`Market value` = as.numeric(trimws(`Market value`))) %>%
  filter(Pos == "DF")
```

```{r}
def_predictions$predictions <- predict(def_rf_fit, def_transfer)
```

```{r}
def_predictions$residuals <- def_predictions$`Market value` - def_predictions$predictions

```

```{r}
def_obs_pred <- ggplot(def_predictions, aes(x = predictions, y = `Market value`, text = Player.x)) +
   geom_point(alpha = 0.6, color = "#56B4E9") +
  geom_abline(intercept = 0, slope = 1, color = "blue") +
  labs(x = "Predicted (€)",
       y = "Observed (€)") +
  scale_x_continuous(labels = scales::label_number(scale = 1e-6, suffix = "M")) +
  scale_y_continuous(labels = scales::label_number(scale = 1e-6, suffix = "M")) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
    panel.grid.minor = element_blank())

ggsave(filename = "def_obs.png", plot = def_obs_pred, width = 6, height = 6, units = "in", dpi = 300)

def_obs_pred_plotly <- ggplotly(def_obs_pred, tooltip = "text")



def_obs_pred_plotly
```

```{r}
def_predictions_res <- def_predictions %>%
  select(Player.x, residuals) %>%
  arrange(desc(residuals))

head(def_predictions_res, 10)

tail(def_predictions_res, 10) 
```

```{r}
def_residuals_plot <- ggplot(def_predictions, aes(x = predictions, y = residuals)) +
  geom_point(alpha = 0.5, color = '#56B4E9') +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  labs(title = "Residuals Plot",
       x = "Predicted Market Value (€)",
       y = "Residuals (Observed - Predicted)") +
  theme_minimal()


ggplotly(def_residuals_plot)
```


```{r}
def_score_transfer <- merge(prem_def_scores, def_predictions, by.x = "Player", by.y = "Player.x")
```


```{r}
def_pearson_corr <- cor(def_score_transfer$Scaled_Score, def_score_transfer$`Market value`, method = "pearson")

def_score_market <- ggplot(def_score_transfer, aes(x = Scaled_Score, y = `Market value`)) +
  geom_point(alpha = 0.9, color = "#56B4E9") +
  labs(x = "Overall Score",
       y = "Market Value (€)") +
  scale_y_continuous(labels = scales::label_number(scale = 1e-6, suffix = "M")) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5),   
    panel.grid.minor = element_blank()         
  ) +
  annotate("text", x = 80, y = max(def_score_transfer$`Market value`, na.rm = TRUE) * 0.9, 
           label = paste(" r =", round(def_pearson_corr, 2)), size = 5, color = "black")

ggsave(filename = "def_score_market.png", plot = def_score_market, width = 6, height = 6, units = "in", dpi = 300)

ggplotly(def_score_market)
```


# MIDFIELDERS

```{r}

set.seed(123456)
mid_index <- createDataPartition(mid_transfer$`Market value`, 
                             p=0.7,
                             list=FALSE, 
                             times = 1)
mid_transfer.train <- mid_transfer[mid_index,]
mid_transfer.test <- mid_transfer[-mid_index,]
```

```{r}
mid_rf_fit <- train(`Market value` ~ .,
                               data = mid_transfer.train,
                               method = 'rf',
                               importance = TRUE,
                               trControl = trainControl(method = 'cv', number = 10))
```

```{r}
mid_rf_fit
```

```{r}
varImp(mid_rf_fit)
mid_var_importance <- varImp(mid_rf_fit, scale = FALSE)

mid_var_importance_df <- data.frame(Variable = rownames(mid_var_importance$importance), Importance = mid_var_importance$importance[,1])

mid_var_importance_df <- mid_var_importance_df %>%
  arrange(desc(Importance))

mid_top_5_importance <- head(mid_var_importance_df, 5)

mid_rf_labels <- c("CarryTotDist" = "Total Carrying\n Distance", "Thruballs" = "Through Balls", "ShortPassCmp" = "Short Pass\n Complete", "PassCmp.x" = "Passes Complete")

mid_varimp <- ggplot(mid_top_5_importance, aes(x = reorder(Variable, Importance), y = Importance)) +
  geom_bar(stat = "identity", fill = "#009e73") +
  coord_flip() +
  labs(x = "Variable",
       y = "Importance") +
  scale_x_discrete(labels = mid_rf_labels) +
  theme_minimal() +
   theme(
    plot.title = element_text(hjust = 0.5),       
    panel.grid.major.y = element_blank(),          
    panel.grid.minor.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.minor.y = element_blank(),
        axis.text.y = element_text(size = 10))

ggsave(filename = "mid_varimp.png", plot = mid_varimp, width = 7, height = 5, units = "in", dpi = 300)
```


```{r}
mid_rf_RMSE <- sqrt(mean((mid_transfer.test$`Market value` - predict(mid_rf_fit, mid_transfer.test))^2))


mid_rf_RMSE
```

```{r}
mid_transfer_mean <- mean(mid_transfer$`Market value`)
mid_transfer_mean
```

```{r}
mid_relative_error <- (mid_rf_RMSE/mid_transfer_mean) * 100
mid_relative_error
```

## Data prep for predictions and residuals

```{r}
mid_predictions <- ff_data %>%
  select(-c(Player.y, Nation, Squad, Born)) %>%
  mutate(`Market value` = as.numeric(trimws(`Market value`))) %>%
  filter(Pos == "MF")
```

```{r}
mid_predictions$predictions <- predict(mid_rf_fit, mid_transfer)
```

```{r}
mid_predictions$residuals <- mid_predictions$`Market value` - mid_predictions$predictions

```

```{r}
mid_obs_pred <- ggplot(mid_predictions, aes(x = predictions, y = `Market value`, text = Player.x)) +
   geom_point(alpha = 0.9, color = "#009e73") +
  geom_abline(intercept = 0, slope = 1, color = "blue") +
  labs(x = "Predicted (€)",
       y = "Observed (€)") +
  scale_x_continuous(labels = scales::label_number(scale = 1e-6, suffix = "M")) +
  scale_y_continuous(labels = scales::label_number(scale = 1e-6, suffix = "M")) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
    panel.grid.minor = element_blank())

ggsave(filename = "mid_obs.png", plot = mid_obs_pred, width = 6, height = 6, units = "in", dpi = 300)

mid_obs_pred_plotly <- ggplotly(mid_obs_pred, tooltip = "text")



mid_obs_pred_plotly
```

```{r}
mid_predictions_res <- mid_predictions %>%
  select(Player.x, residuals) %>%
  arrange(desc(residuals))

head(mid_predictions_res, 10)

tail(mid_predictions_res, 10) 
```

```{r}
mid_residuals_plot <- ggplot(mid_predictions, aes(x = predictions, y = residuals)) +
  geom_point(alpha = 0.5, color = '#009E73') +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  labs(title = "Residuals Plot",
       x = "Predicted Market Value (€)",
       y = "Residuals (Observed - Predicted)") +
  theme_minimal()

ggplotly(mid_residuals_plot)
```


```{r}
mid_score_transfer <- merge(prem_mid_scores, mid_predictions, by.x = "Player", by.y = "Player.x")
```


```{r}
mid_pearson_corr <- cor(mid_score_transfer$Scaled_Score, mid_score_transfer$`Market value`, method = "pearson")

mid_score_market <- ggplot(mid_score_transfer, aes(x = Scaled_Score, y = `Market value`)) +
  geom_point(alpha = 0.9, color = "#009E73") +
  labs(x = "Overall Score",
       y = "Market Value (€)") +
  scale_y_continuous(labels = scales::label_number(scale = 1e-6, suffix = "M")) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5),   
    panel.grid.minor = element_blank()         
  ) +
  annotate("text", x = 80, y = max(mid_score_transfer$`Market value`, na.rm = TRUE) * 0.9, 
           label = paste(" r =", round(mid_pearson_corr, 2)), size = 5, color = "black")


ggsave(filename = "mid_score_market.png", plot = mid_score_market, width = 6, height = 6, units = "in", dpi = 300)

ggplotly(mid_score_market)



```  



# FORWARDS

```{r}
fwd_index <- createDataPartition(fwd_transfer$`Market value`, 
                             p=0.7,
                             list=FALSE, 
                             times = 1)
fwd_transfer.train <- fwd_transfer[fwd_index,]
fwd_transfer.test <- fwd_transfer[-fwd_index,]
```

```{r}
fwd_rf_fit <- train(`Market value` ~ .,
                               data = fwd_transfer.train,
                               method = 'rf',
                               importance = TRUE,
                               trControl = trainControl(method = 'cv', number = 10))
```

```{r}
fwd_rf_fit
```

```{r}
varImp(fwd_rf_fit)
fwd_var_importance <- varImp(fwd_rf_fit, scale = FALSE)

fwd_var_importance_df <- data.frame(Variable = rownames(fwd_var_importance$importance), Importance = fwd_var_importance$importance[,1])

fwd_var_importance_df <- fwd_var_importance_df %>%
  arrange(desc(Importance))

fwd_top_5_importance <- head(fwd_var_importance_df, 5)

fwd_rf_labels <- c("Gls" = "Goals", "npxG" = "Non Penalty\n Expected Goals", "`Touches AttPA`" = "Touches Attacking\n Penalty Area", "`Touches Att3`" = "Touches Attacking\n Third", "Sh" = "Shots")

fwd_varimp <- ggplot(fwd_top_5_importance, aes(x = reorder(Variable, Importance), y = Importance)) +
  geom_bar(stat = "identity", fill = "#CC79A7") +
  coord_flip() +
  labs(x = "Variable",
       y = "Importance") +
  scale_x_discrete(labels = fwd_rf_labels) +
  theme_minimal() +
   theme(
    plot.title = element_text(hjust = 0.5),       
    panel.grid.major.y = element_blank(),          
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank(),
    panel.grid.minor.y = element_blank(),
        axis.text.y = element_text(size = 10))

ggsave(filename = "fwd_varimp.png", plot = fwd_varimp, width = 7, height = 5, units = "in", dpi = 300)

```


```{r}
fwd_rf_RMSE <- sqrt(mean((fwd_transfer.test$`Market value` - predict(fwd_rf_fit, fwd_transfer.test))^2))

fwd_rf_RMSE
```

```{r}
fwd_transfer_mean <- mean(fwd_transfer$`Market value`)
fwd_transfer_mean
```

```{r}
fwd_relative_error <- (fwd_rf_RMSE/fwd_transfer_mean) * 100
fwd_relative_error
```

## Data prep for predictions and residuals

```{r}
fwd_predictions <- ff_data %>%
  select(-c(Player.y, Nation, Squad, Born)) %>%
  mutate(`Market value` = as.numeric(trimws(`Market value`))) %>%
  filter(Pos == "FW")
```

```{r}
fwd_predictions$predictions <- predict(fwd_rf_fit, fwd_transfer)
```

```{r}
fwd_predictions$residuals <- fwd_predictions$`Market value` - fwd_predictions$predictions


```

```{r}
fwd_obs_pred <- ggplot(fwd_predictions, aes(x = predictions, y = `Market value`, text = Player.x)) +
  geom_point(alpha = 0.9, color = "#CC79A7") +
  geom_abline(intercept = 0, slope = 1, color = "blue") +
  labs(x = "Predicted (€)",
       y = "Observed (€)") +
  scale_x_continuous(labels = scales::label_number(scale = 1e-6, suffix = "M")) +
  scale_y_continuous(labels = scales::label_number(scale = 1e-6, suffix = "M")) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
    panel.grid.minor = element_blank())

ggsave(filename = "fwd_obs.png", plot = fwd_obs_pred, width = 6, height = 6, units = "in", dpi = 300)


fwd_obs_pred_plotly <- ggplotly(fwd_obs_pred, tooltip = "text")



fwd_obs_pred_plotly
```

```{r}
fwd_predictions_res <- fwd_predictions %>%
  select(Player.x, residuals) %>%
  arrange(desc(residuals))

head(fwd_predictions_res, 10)

tail(fwd_predictions_res, 10) 
```

```{r}
fwd_residuals_plot <- ggplot(fwd_predictions, aes(x = predictions, y = residuals)) +
  geom_point(alpha = 0.5, color = '#CC79A7') +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  labs(title = "Residuals Plot",
       x = "Predicted Market Value (€)",
       y = "Residuals (Observed - Predicted)") +
  theme_minimal()

ggplotly(fwd_residuals_plot)
```


```{r}
fwd_score_transfer <- merge(prem_fwd_scores, fwd_predictions, by.x = "Player", by.y = "Player.x")

fwd_score_transfer <- fwd_score_transfer %>%
  select(Player, Scaled_Score, `Market value`)
```


```{r}
fwd_pearson_corr <- cor(fwd_score_transfer$Scaled_Score, fwd_score_transfer$`Market value`, method = "pearson")

fwd_score_market <- ggplot(fwd_score_transfer, aes(x = Scaled_Score, y = `Market value`)) +
  geom_point(alpha = 0.9, color = "#CC79A7") +
  labs(x = "Overall Score",
       y = "Market Value (€)") +
  scale_y_continuous(labels = scales::label_number(scale = 1e-6, suffix = "M")) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5),   
    panel.grid.minor = element_blank()         
  ) +
  annotate("text", x = 80, y = max(fwd_score_transfer$`Market value`, na.rm = TRUE) * 0.9, 
           label = paste(" r =", round(fwd_pearson_corr, 2)), size = 5, color = "black")


ggsave(filename = "fwd_score_market.png", plot = fwd_score_market, width = 6, height = 6, units = "in", dpi = 300)


ggplotly(fwd_score_market)
```     


```{r}
cor(fwd_score_transfer$Overall_Score, fwd_score_transfer$`Market value`, method = "pearson")
```


```{r}
def_performance <- data.frame(
  Model = "Defender",
  Rsquared = round(def_rf_fit$results$Rsquared[which.max(def_rf_fit$results$RMSE)], 2),
  RMSE = round(sqrt(mean((def_transfer.test$`Market value` - predict(def_rf_fit, def_transfer.test))^2)), 2),
  RelativeError = round((sqrt(mean((def_transfer.test$`Market value` - predict(def_rf_fit, def_transfer.test))^2)) / mean(def_transfer$`Market value`)) * 100, 2)
)


mid_performance <- data.frame(
  Model = "Midfielder",
  Rsquared = round(mid_rf_fit$results$Rsquared[which.max(mid_rf_fit$results$RMSE)], 2),
  RMSE = round(sqrt(mean((mid_transfer.test$`Market value` - predict(mid_rf_fit, mid_transfer.test))^2)), 2),
  RelativeError = round((sqrt(mean((mid_transfer.test$`Market value` - predict(mid_rf_fit, mid_transfer.test))^2)) / mean(mid_transfer$`Market value`)) * 100, 2)
)

fwd_performance <- data.frame(
  Model = "Forward",
  Rsquared = round(fwd_rf_fit$results$Rsquared[which.max(fwd_rf_fit$results$RMSE)], 2),
  RMSE = round(sqrt(mean((fwd_transfer.test$`Market value` - predict(fwd_rf_fit, fwd_transfer.test))^2)), 2),
  RelativeError = round((sqrt(mean((fwd_transfer.test$`Market value` - predict(fwd_rf_fit, fwd_transfer.test))^2)) / mean(fwd_transfer$`Market value`)) * 100, 2)
)


performance_df <- bind_rows(def_performance, mid_performance, fwd_performance)

performance_table <- gt(performance_df) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold", align = "center"),
      cell_borders(
        sides = "all",
        color = "black",
        weight = px(1)
      )
    ),
    locations = cells_column_labels(everything())
  ) %>%
  tab_style(
    style = list(
      cell_text(align = "center"),
      cell_borders(
        sides = "all",
        color = "black",
        weight = px(1)
      )
    ),
    locations = cells_body()
  ) %>%
  tab_options(
    table.border.top.color = "black",
    table.border.bottom.color = "black",
    table.font.size = 12
  )


gtsave(performance_table, "performance_table.png")
```


```{r}
get_top_5_residuals <- function(df, type) {
  df %>%
    arrange(desc(residuals)) %>%
    select(Player = Player.x, Residual = residuals) %>%
    mutate(Type = type) %>%
    head(5)
}


top5_fwd <- get_top_5_residuals(fwd_predictions, "Forward")
top5_def <- get_top_5_residuals(def_predictions, "Defender")
top5_mid <- get_top_5_residuals(mid_predictions, "Midfielder")


combined_table <- bind_cols(
  top5_def %>% rename_with(~ paste0(., "_Def")),
  top5_mid %>% rename_with(~ paste0(., "_Mid")),
  top5_fwd %>% rename_with(~ paste0(., "_Fwd"))
)


gt_table <- gt(combined_table) %>%
  cols_label(
    Player_Def = "Player", Residual_Def = "Residual", Type_Def = "Type",
    Player_Mid = "Player", Residual_Mid = "Residual", Type_Mid = "Type",
    Player_Fwd = "Player", Residual_Fwd = "Residual", Type_Fwd = "Type"
  ) %>%
  tab_style(
    style = cell_text(weight = "bold", align = "center"),
    locations = cells_column_labels(everything())
  ) %>%
  tab_style(
    style = cell_text(align = "center"),
    locations = cells_body()
  ) %>%
  tab_style(
    style = cell_borders(sides = "all", color = "black", weight = px(1)),
    locations = list(cells_body(), cells_column_labels())
  ) %>%
  tab_options(
    table.border.top.color = "black",
    table.border.bottom.color = "black",
    table.font.size = 12
  )


gtsave(gt_table, "top5_residuals_table.png")
```

```{r}
get_bottom_5_residuals <- function(df, type) {
  df %>%
    arrange(residuals) %>%
    select(Player = Player.x, Residual = residuals) %>%
    mutate(Type = type) %>%
    head(5)
}


bottom5_fwd <- get_bottom_5_residuals(fwd_predictions, "Forward")
bottom5_def <- get_bottom_5_residuals(def_predictions, "Defender")
bottom5_mid <- get_bottom_5_residuals(mid_predictions, "Midfielder")


combined_table_bottom <- bind_cols(
  bottom5_def %>% rename_with(~ paste0(., "_Def")),
  bottom5_mid %>% rename_with(~ paste0(., "_Mid")),
  bottom5_fwd %>% rename_with(~ paste0(., "_Fwd"))
)


gt_table_bottom <- gt(combined_table_bottom) %>%
  cols_label(
    Player_Def = "Player", Residual_Def = "Residual", Type_Def = "Type",
    Player_Mid = "Player", Residual_Mid = "Residual", Type_Mid = "Type",
    Player_Fwd = "Player", Residual_Fwd = "Residual", Type_Fwd = "Type"
  ) %>%
  tab_style(
    style = cell_text(weight = "bold", align = "center"),
    locations = cells_column_labels(everything())
  ) %>%
  tab_style(
    style = cell_text(align = "center"),
    locations = cells_body()
  ) %>%
  tab_style(
    style = cell_borders(sides = "all", color = "black", weight = px(1)),
    locations = list(cells_body(), cells_column_labels())
  ) %>%
  tab_options(
    table.border.top.color = "black",
    table.border.bottom.color = "black",
    table.font.size = 12
  )


gtsave(gt_table_bottom, "bottom5_residuals_table.png")
```

